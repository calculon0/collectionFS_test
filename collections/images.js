FS.debug = true;

//Set Cache Control headers so we don't overload our meteor server with http requests
FS.HTTP.setHeadersForGet([
    ['Cache-Control', 'public, max-age=31536000']
    ]);

//Create the master store
var masterStore = new FS.Store.GridFS("master");

//Create a thumbnail store
var thumbnailStore = new FS.Store.GridFS("thumbnail", {
    //Create the thumbnail as we save to the store.
    transformWrite: function(fileObj, readStream, writeStream) {
        /* Use graphicsmagick to create a 300x300 square thumbnail at 100% quality,
        * orient according to EXIF data if necessary and then save by piping to the 
        * provided writeStream */
        gm(readStream, fileObj.name).resize(300,300,"^")
        .gravity('Center').crop(300, 300).quality(100).autoOrient().stream().pipe(writeStream);
    }
});



//Create globally scoped Images collection.
Images = new FS.Collection("images", {
    stores: [thumbnailStore, masterStore, new FS.Store.FileSystem("storedfiles", { path: "~/app-files/images" })],
    filter: {
        maxSize: 10485760, //in bytes
        allow: {
            contentTypes: ['image/*'],
            extensions: ['png', 'jpg', 'jpeg', 'gif']
        },
        onInvalid: function (message) {
            if(Meteor.isClient){
                alert(message);
            }else{
                console.warn(message);
            }
        }
    }
});


//Use allow to control insert, update, remove and download. In this case we will just allow them all.
Images.allow({
    insert: function(userId, file) {
        return true;
    },
    update: function(userId, file, fields, modifier) {
        return true;
    },
    remove: function(userId, file) {
        return true;
    },
    download: function() {
        return true;
    }
});


//If we're on the server publish the collection, otherwise we are on the client and we should subscribe to the publication.
if(Meteor.isServer){

    Meteor.publish('images', function () {
        /*Uncomment this and comment out returning the cursor to see publication issue*/

        // var self = this;

        // var handle = Images.find().observe({
        //     added: function (document) {
        //         self.added('images', document._id, document);
        //     },
        //     changed: function (document) {
        //         self.changed('images', document._id, document);
        //     },
        //     removed: function (document) {
        //         self.removed('images', document._id);
        //     }
        // });

        // self.onStop(function () {
        //     handle.stop();
        // });

        /*Comment this out and Uncomment manual publishing to see publication issue*/

        return Images.find();

    });

    //if you comment this out, the next Buffer insert won't work
    var imageFile = new FS.File('/Users/calculon0/Desktop/tech.jpg');
    imageFile.metadata = {
      owner: 'ABCD2345',
      projectID: 'ASDF1234'
    };
    Images.insert(imageFile);

    //this only works if the previous insert is run
    var fileDataBuffer = new Buffer("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", "base64");
    var newFile = new FS.File( {
      name: 'test.jpg',
      size: fileDataBuffer.length,
      contentType: 'image/jpeg',
      metadata: {
        owner: "blah",
        uploadedAt: new Date
      }
    });
    newFile.attachData(fileDataBuffer, {type: 'image/jpeg'});
    Images.insert(newFile);

}else{
    Meteor.subscribe('images');
}